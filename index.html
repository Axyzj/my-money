<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>éšæ‰‹è®° Pro Max</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #F3F4F6; 
            -webkit-tap-highlight-color: transparent; 
            padding-bottom: 40px; 
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .glass-header {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            padding-top: env(safe-area-inset-top);
        }
        .input-group { transition: all 0.2s; }
        .input-group:focus-within { transform: scale(1.01); }
        
        /* ç‚¹å‡»å¡ç‰‡çš„åé¦ˆæ•ˆæœ */
        .stat-card { transition: transform 0.1s, background-color 0.2s; cursor: pointer; }
        .stat-card:active { transform: scale(0.95); background-color: rgba(255,255,255,0.2); }

        /* å¼¹çª—åŠ¨ç”» */
        .modal-enter { transform: translateY(100%); opacity: 0; }
        .modal-enter-active { transform: translateY(0); opacity: 1; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-exit { transform: translateY(100%); opacity: 0; transition: all 0.2s ease-in; }
    </style>
</head>
<body>

    <div class="glass-header text-white pb-8 rounded-b-[30px] shadow-lg relative z-10">
        <div class="px-6 pt-6 pb-2">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-blue-100 text-sm font-medium mb-1">æœ¬æœˆæ€»æ”¯å‡º</p>
                    <h1 class="text-4xl font-bold tracking-tight" id="stat-month">Â¥0.00</h1>
                </div>
                <button onclick="exportData()" class="bg-white/20 hover:bg-white/30 backdrop-blur-md px-3 py-1.5 rounded-full text-xs font-medium transition">
                    ğŸ“¤ å¤‡ä»½
                </button>
            </div>
            
            <div class="grid grid-cols-3 gap-3 mt-6">
                <div onclick="showDetail('day')" class="stat-card bg-white/10 backdrop-blur-sm rounded-xl p-3 text-center relative overflow-hidden">
                    <p class="text-xs text-blue-100 mb-1">ä»Šæ—¥</p>
                    <p class="font-bold text-sm" id="stat-day">Â¥0</p>
                    <div class="absolute inset-0 bg-white/5 opacity-0 hover:opacity-100 transition"></div>
                </div>
                <div onclick="showDetail('week')" class="stat-card bg-white/10 backdrop-blur-sm rounded-xl p-3 text-center relative overflow-hidden">
                    <p class="text-xs text-blue-100 mb-1">æœ¬å‘¨</p>
                    <p class="font-bold text-sm" id="stat-week">Â¥0</p>
                    <div class="absolute inset-0 bg-white/5 opacity-0 hover:opacity-100 transition"></div>
                </div>
                <div onclick="showDetail('month')" class="stat-card bg-white/10 backdrop-blur-sm rounded-xl p-3 text-center relative overflow-hidden">
                    <p class="text-xs text-blue-100 mb-1">æœ¬æœˆ</p>
                    <p class="font-bold text-sm" id="stat-month-small">Â¥0</p>
                    <div class="absolute inset-0 bg-white/5 opacity-0 hover:opacity-100 transition"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="px-4 -mt-6 relative z-20">
        <div class="bg-white rounded-2xl shadow-md p-4 input-group">
            <h2 class="text-gray-400 text-xs font-bold uppercase mb-3 tracking-wider">è®°ä¸€ç¬”</h2>
            <div class="flex gap-2 mb-3">
                <input type="date" id="input-date" class="bg-gray-50 border-0 rounded-xl p-3 text-gray-700 font-medium text-sm flex-1 focus:ring-2 focus:ring-indigo-500 outline-none">
                <select id="input-category" class="bg-gray-50 border-0 rounded-xl p-3 text-gray-700 font-medium text-sm w-1/3 focus:ring-2 focus:ring-indigo-500 outline-none appearance-none text-center">
                    <option value="é¤é¥®">ğŸ” é¤é¥®</option>
                    <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                    <option value="è´­ç‰©">ğŸ›ï¸ è´­ç‰©</option>
                    <option value="å¨±ä¹">ğŸ¬ å¨±ä¹</option>
                    <option value="å±…ä½">ğŸ  å±…ä½</option>
                    <option value="åŒ»ç–—">ğŸ’Š åŒ»ç–—</option>
                    <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                </select>
            </div>
            <div class="flex items-center gap-3">
                <div class="relative flex-1">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">Â¥</span>
                    <input type="number" id="input-amount" step="0.01" placeholder="0.00" class="w-full bg-gray-50 border-0 rounded-xl pl-8 pr-3 py-3 text-xl font-bold text-gray-800 focus:ring-2 focus:ring-indigo-500 outline-none placeholder-gray-300">
                </div>
                <button onclick="addExpense()" class="bg-indigo-600 active:bg-indigo-700 text-white w-14 h-12 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-200 transition-transform active:scale-95">
                    <span class="text-2xl font-bold">+</span>
                </button>
            </div>
        </div>
    </div>

    <div class="px-5 mt-6">
        <div class="flex justify-between items-end mb-4">
            <h3 class="text-lg font-bold text-gray-800">è¿‘æœŸè´¦å•</h3>
            <button onclick="clearAll()" class="text-xs text-gray-400 py-1">æ¸…ç©º</button>
        </div>
        <div id="expense-list" class="space-y-3 pb-safe"></div>
        <div id="empty-state" class="hidden text-center py-10">
            <div class="text-4xl mb-2">ğŸƒ</div>
            <p class="text-gray-400 text-sm">æš‚æ— è®°å½•ï¼Œå¼€å¯è®°è´¦ç”Ÿæ´»å§</p>
        </div>
    </div>

    <div id="modal-backdrop" onclick="closeModal()" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 hidden opacity-0 transition-opacity duration-300"></div>
    <div id="modal-content" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-[2rem] p-6 z-50 modal-enter hidden h-[70vh] flex flex-col shadow-2xl">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
        
        <div class="flex justify-between items-baseline mb-4">
            <h2 class="text-xl font-bold text-gray-800" id="modal-title">æ¶ˆè´¹åˆ†æ</h2>
            <div class="text-2xl font-bold text-indigo-600" id="modal-total">Â¥0.00</div>
        </div>

        <div id="modal-list" class="overflow-y-auto flex-1 space-y-4 pr-1">
            </div>

        <button onclick="closeModal()" class="mt-4 w-full bg-gray-100 text-gray-600 py-3 rounded-xl font-bold active:bg-gray-200">å…³é—­</button>
    </div>

<script>
    let expenses = JSON.parse(localStorage.getItem('myAccountBookPro')) || [];
    document.getElementById('input-date').valueAsDate = new Date();
    
    const categoryColors = {
        'é¤é¥®': 'bg-orange-100 text-orange-600',
        'äº¤é€š': 'bg-blue-100 text-blue-600',
        'è´­ç‰©': 'bg-pink-100 text-pink-600',
        'å¨±ä¹': 'bg-purple-100 text-purple-600',
        'å±…ä½': 'bg-green-100 text-green-600',
        'åŒ»ç–—': 'bg-red-100 text-red-600',
        'å…¶ä»–': 'bg-gray-100 text-gray-600'
    };

    const categoryBgColors = { 
        'é¤é¥®': 'bg-orange-500', 'äº¤é€š': 'bg-blue-500', 'è´­ç‰©': 'bg-pink-500',
        'å¨±ä¹': 'bg-purple-500', 'å±…ä½': 'bg-green-500', 'åŒ»ç–—': 'bg-red-500', 'å…¶ä»–': 'bg-gray-500'
    };

    render();

    // --- æ ¸å¿ƒé€»è¾‘ ---

    function addExpense() {
        const dateEl = document.getElementById('input-date');
        const amountEl = document.getElementById('input-amount');
        const catEl = document.getElementById('input-category');

        if (!dateEl.value || !amountEl.value) {
            if(navigator.vibrate) navigator.vibrate(200);
            alert("âš ï¸ è¯·è¾“å…¥æ—¥æœŸå’Œé‡‘é¢");
            return;
        }

        const newRecord = {
            id: Date.now(),
            date: dateEl.value,
            amount: parseFloat(amountEl.value),
            category: catEl.value
        };

        expenses.unshift(newRecord);
        saveAndRender();
        amountEl.value = '';
        amountEl.focus(); 
    }

    function deleteItem(id) {
        if(confirm("ç¡®å®šåˆ é™¤å—ï¼Ÿ")) {
            expenses = expenses.filter(e => e.id !== id);
            saveAndRender();
        }
    }

    function saveAndRender() {
        localStorage.setItem('myAccountBookPro', JSON.stringify(expenses));
        render();
    }

    // --- å¼¹çª—é€»è¾‘ (ä¿®æ”¹ï¼šæ”¯æŒ month ç±»å‹) ---

    function showDetail(type) {
        const now = new Date();
        const todayStr = now.toISOString().split('T')[0];
        const currentYear = now.getFullYear();
        const currentMonthStr = now.toISOString().slice(0, 7); 
        
        // å‘¨è®¡ç®—å·¥å…·
        const getWeekNumber = d => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        };
        const currentWeek = getWeekNumber(now);

        // 1. ç­›é€‰æ•°æ®
        let filteredData = [];
        let title = "";

        if (type === 'day') {
            title = "ä»Šæ—¥æ¶ˆè´¹æ„æˆ";
            filteredData = expenses.filter(e => e.date === todayStr);
        } else if (type === 'week') {
            title = "æœ¬å‘¨æ¶ˆè´¹æ„æˆ";
            filteredData = expenses.filter(e => {
                const eDate = new Date(e.date);
                return eDate.getFullYear() === currentYear && getWeekNumber(eDate) === currentWeek;
            });
        } else if (type === 'month') { // ä¿®æ”¹å¤„ï¼šæ·»åŠ æœ¬æœˆç­›é€‰é€»è¾‘
            title = "æœ¬æœˆæ¶ˆè´¹æ„æˆ";
            filteredData = expenses.filter(e => e.date.startsWith(currentMonthStr));
        }

        // 2. èšåˆæ•°æ® (æŒ‰ç±»åˆ«åˆ†ç»„)
        let categoryMap = {};
        let totalAmount = 0;

        filteredData.forEach(e => {
            if (!categoryMap[e.category]) categoryMap[e.category] = 0;
            categoryMap[e.category] += e.amount;
            totalAmount += e.amount;
        });

        // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
        let sortedCategories = Object.keys(categoryMap).map(key => {
            return { name: key, value: categoryMap[key] };
        }).sort((a, b) => b.value - a.value);

        // 3. æ¸²æŸ“å¼¹çª—å†…å®¹
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-total').innerText = 'Â¥' + formatMoney(totalAmount);
        const listEl = document.getElementById('modal-list');
        listEl.innerHTML = '';

        if (sortedCategories.length === 0) {
            listEl.innerHTML = '<div class="text-center text-gray-400 mt-10">æš‚æ— æ•°æ®</div>';
        } else {
            sortedCategories.forEach(item => {
                const percent = ((item.value / totalAmount) * 100).toFixed(1);
                const barColor = categoryBgColors[item.name] || 'bg-gray-500';
                const iconColor = categoryColors[item.name] || categoryColors['å…¶ä»–'];

                const row = document.createElement('div');
                row.className = 'mb-2';
                row.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <div class="flex items-center gap-2">
                            <span class="${iconColor} w-6 h-6 rounded flex items-center justify-center text-xs font-bold">
                                ${item.name.substring(0,1)}
                            </span>
                            <span class="text-gray-700 font-medium">${item.name}</span>
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-gray-800">Â¥${formatMoney(item.value)}</span>
                            <span class="text-xs text-gray-400 ml-1">${percent}%</span>
                        </div>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                        <div class="${barColor} h-2 rounded-full" style="width: ${percent}%"></div>
                    </div>
                `;
                listEl.appendChild(row);
            });
        }

        // 4. æ˜¾ç¤ºå¼¹çª—
        const backdrop = document.getElementById('modal-backdrop');
        const content = document.getElementById('modal-content');
        
        backdrop.classList.remove('hidden');
        content.classList.remove('hidden');
        
        // å»¶æ—¶æ·»åŠ åŠ¨ç”»classä»¥è§¦å‘transition
        setTimeout(() => {
            backdrop.classList.remove('opacity-0');
            content.classList.remove('modal-enter');
            content.classList.add('modal-enter-active');
        }, 10);
    }

    function closeModal() {
        const backdrop = document.getElementById('modal-backdrop');
        const content = document.getElementById('modal-content');

        backdrop.classList.add('opacity-0');
        content.classList.remove('modal-enter-active');
        content.classList.add('modal-exit');

        setTimeout(() => {
            backdrop.classList.add('hidden');
            content.classList.add('hidden');
            content.classList.remove('modal-exit');
            content.classList.add('modal-enter'); 
        }, 300);
    }

    // --- æ¸²æŸ“ä¸»é¡µ ---

    function render() {
        let d=0, w=0, m=0, y=0;
        const now = new Date();
        const todayStr = now.toISOString().split('T')[0];
        const currentMonthStr = now.toISOString().slice(0, 7); 
        const currentYear = now.getFullYear();
        
        const getWeekNumber = d => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        };
        const currentWeek = getWeekNumber(now);

        expenses.forEach(e => {
            const eDate = new Date(e.date);
            if(e.date === todayStr) d += e.amount;
            if(e.date.startsWith(currentMonthStr)) m += e.amount;
            if(eDate.getFullYear() === currentYear) {
                y += e.amount;
                if(getWeekNumber(eDate) === currentWeek) w += e.amount;
            }
        });

        document.getElementById('stat-day').innerText = formatMoney(d);
        document.getElementById('stat-week').innerText = formatMoney(w);
        // å¤§å¡ç‰‡æ›´æ–°
        document.getElementById('stat-month').innerText = formatMoney(m);
        // å°å¡ç‰‡æ›´æ–° (ä¿®æ”¹å¤„ï¼šæ›´æ–°æœ¬æœˆå°å¡ç‰‡)
        document.getElementById('stat-month-small').innerText = formatMoney(m);

        const listEl = document.getElementById('expense-list');
        const emptyEl = document.getElementById('empty-state');
        listEl.innerHTML = '';

        if (expenses.length === 0) {
            emptyEl.classList.remove('hidden');
        } else {
            emptyEl.classList.add('hidden');
            expenses.forEach(item => {
                const colorClass = categoryColors[item.category] || categoryColors['å…¶ä»–'];
                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded-xl shadow-sm flex items-center justify-between';
                card.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="${colorClass} w-10 h-10 rounded-lg flex items-center justify-center text-lg font-bold">
                            ${item.category.substring(0,1)}
                        </div>
                        <div>
                            <div class="font-bold text-gray-800 text-base">Â¥${formatMoney(item.amount)}</div>
                            <div class="text-xs text-gray-400 mt-0.5">${item.date} Â· ${item.category}</div>
                        </div>
                    </div>
                    <button onclick="deleteItem(${item.id})" class="text-gray-300 hover:text-red-500 px-2 py-2">
                        âœ•
                    </button>
                `;
                listEl.appendChild(card);
            });
        }
    }

    function formatMoney(num) {
        return num.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function clearAll() {
        if(confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ")) {
            expenses = [];
            saveAndRender();
        }
    }

    function exportData() {
        const str = JSON.stringify(expenses);
        const el = document.createElement('textarea');
        el.value = str;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        alert("æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼è¯·ç²˜è´´åˆ°å¤‡å¿˜å½•ä¿å­˜ã€‚");
    }
</script>
</body>
</html>