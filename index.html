<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å®¶åº­äº‘è®°è´¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="//code.bdstatic.com/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #F3F4F6; 
            -webkit-tap-highlight-color: transparent; 
            padding-bottom: 40px; 
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .glass-header {
            background: linear-gradient(135deg, #059669 0%, #10B981 100%); /* æ¢ä¸ªç»¿è‰²ç³»ä»£è¡¨äº‘ç«¯å®‰å…¨ */
            padding-top: env(safe-area-inset-top);
        }
        .stat-card { transition: transform 0.1s; cursor: pointer; }
        .stat-card:active { transform: scale(0.95); background-color: rgba(255,255,255,0.2); }
        
        /* åŠ è½½åŠ¨ç”» */
        .spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* é®ç½©å±‚åŠ è½½ */
        #loading-overlay { display: none; }
        #loading-overlay.active { display: flex; }
    </style>
</head>
<body>

    <div id="loading-overlay" class="fixed inset-0 bg-black/30 z-[60] justify-center items-center backdrop-blur-sm">
        <div class="bg-white p-4 rounded-xl flex items-center gap-3 shadow-xl">
            <div class="spinner" style="border-top-color: #059669; border-color: #eee;"></div>
            <span class="text-sm font-bold text-gray-600">æ•°æ®åŒæ­¥ä¸­...</span>
        </div>
    </div>

    <div class="glass-header text-white pb-8 rounded-b-[30px] shadow-lg relative z-10">
        <div class="px-6 pt-6 pb-2">
            <div class="flex justify-between items-start">
                <div>
                    <p class="text-green-100 text-sm font-medium mb-1 flex items-center gap-1">
                        â˜ï¸ å®¶åº­æœ¬æœˆæ€»æ”¯å‡º
                    </p>
                    <h1 class="text-4xl font-bold tracking-tight" id="stat-month">Â¥0.00</h1>
                </div>
                <button onclick="fetchData()" class="bg-white/20 hover:bg-white/30 backdrop-blur-md px-3 py-1.5 rounded-full text-xs font-medium transition flex items-center gap-1">
                    ğŸ”„ åˆ·æ–°
                </button>
            </div>
            
            <div class="grid grid-cols-3 gap-3 mt-6">
                <div onclick="showDetail('day')" class="stat-card bg-white/10 backdrop-blur-sm rounded-xl p-3 text-center">
                    <p class="text-xs text-green-100 mb-1">ä»Šæ—¥</p>
                    <p class="font-bold text-sm" id="stat-day">Â¥0</p>
                </div>
                <div onclick="showDetail('week')" class="stat-card bg-white/10 backdrop-blur-sm rounded-xl p-3 text-center">
                    <p class="text-xs text-green-100 mb-1">æœ¬å‘¨</p>
                    <p class="font-bold text-sm" id="stat-week">Â¥0</p>
                </div>
                <div onclick="showDetail('month')" class="stat-card bg-white/10 backdrop-blur-sm rounded-xl p-3 text-center">
                    <p class="text-xs text-green-100 mb-1">æœ¬æœˆ</p>
                    <p class="font-bold text-sm" id="stat-month-small">Â¥0</p>
                </div>
            </div>
        </div>
    </div>

    <div class="px-4 -mt-6 relative z-20">
        <div class="bg-white rounded-2xl shadow-md p-4">
            <h2 class="text-gray-400 text-xs font-bold uppercase mb-3 tracking-wider">è®°ä¸€ç¬”</h2>
            <div class="flex gap-2 mb-3">
                <input type="date" id="input-date" class="bg-gray-50 border-0 rounded-xl p-3 text-gray-700 font-medium text-sm flex-1 focus:ring-2 focus:ring-green-500 outline-none">
                <select id="input-category" class="bg-gray-50 border-0 rounded-xl p-3 text-gray-700 font-medium text-sm w-1/3 focus:ring-2 focus:ring-green-500 outline-none appearance-none text-center">
                    <option value="é¤é¥®">ğŸ” é¤é¥®</option>
                    <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                    <option value="è´­ç‰©">ğŸ›ï¸ è´­ç‰©</option>
                    <option value="å¨±ä¹">ğŸ¬ å¨±ä¹</option>
                    <option value="å±…ä½">ğŸ  å±…ä½</option>
                    <option value="åŒ»ç–—">ğŸ’Š åŒ»ç–—</option>
                    <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
                </select>
            </div>
            <div class="flex items-center gap-3">
                <div class="relative flex-1">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 font-bold">Â¥</span>
                    <input type="number" id="input-amount" step="0.01" placeholder="0.00" class="w-full bg-gray-50 border-0 rounded-xl pl-8 pr-3 py-3 text-xl font-bold text-gray-800 focus:ring-2 focus:ring-green-500 outline-none placeholder-gray-300">
                </div>
                <button onclick="addExpense()" class="bg-green-600 active:bg-green-700 text-white w-14 h-12 rounded-xl flex items-center justify-center shadow-lg shadow-green-200 transition-transform active:scale-95">
                    <span class="text-2xl font-bold">+</span>
                </button>
            </div>
        </div>
    </div>

    <div class="px-5 mt-6">
        <div class="flex justify-between items-end mb-4">
            <h3 class="text-lg font-bold text-gray-800">äº‘ç«¯åŒæ­¥åˆ—è¡¨</h3>
            <span class="text-xs text-gray-400">åªæ˜¾ç¤ºæœ€è¿‘30æ¡</span>
        </div>
        <div id="expense-list" class="space-y-3 pb-safe"></div>
        <div id="empty-state" class="hidden text-center py-10">
            <div class="text-4xl mb-2">â˜ï¸</div>
            <p class="text-gray-400 text-sm">æš‚æ— äº‘ç«¯æ•°æ®ï¼Œè®°ä¸€ç¬”è¯•è¯•</p>
        </div>
    </div>

    <div id="modal-backdrop" onclick="closeModal()" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-40 hidden opacity-0 transition-opacity duration-300"></div>
    <div id="modal-content" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-[2rem] p-6 z-50 modal-enter hidden h-[70vh] flex flex-col shadow-2xl">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
        <div class="flex justify-between items-baseline mb-4">
            <h2 class="text-xl font-bold text-gray-800" id="modal-title">åˆ†æ</h2>
            <div class="text-2xl font-bold text-green-600" id="modal-total">Â¥0.00</div>
        </div>
        <div id="modal-list" class="overflow-y-auto flex-1 space-y-4 pr-1"></div>
        <button onclick="closeModal()" class="mt-4 w-full bg-gray-100 text-gray-600 py-3 rounded-xl font-bold active:bg-gray-200">å…³é—­</button>
    </div>

<script>
    // =======================================================
    // âš ï¸âš ï¸âš ï¸ è¯·å…ˆä¿®æ”¹ä¸‹é¢è¿™ä¸‰è¡Œé…ç½®ï¼
    // =======================================================
    const APP_ID = '8u7WoVUdMfDaMusRu2mue6fS-gzGzoHsz';
    const APP_KEY = 'UoaSDPu6WSoZsVw0t3F4km1o';
    const SERVER_URL = 'https://8u7wovud.lc-cn-n1-shared.com'; 
    // ä¾‹å¦‚: const SERVER_URL = 'https://u9xxxxx.api.lncldglobal.com';
    // =======================================================

    // åˆå§‹åŒ– LeanCloud
    AV.init({ appId: APP_ID, appKey: APP_KEY, serverURL: SERVER_URL });

    let expenses = []; // æœ¬åœ°ç¼“å­˜æ•°æ®
    document.getElementById('input-date').valueAsDate = new Date();

    const categoryColors = {
        'é¤é¥®': 'bg-orange-100 text-orange-600',
        'äº¤é€š': 'bg-blue-100 text-blue-600',
        'è´­ç‰©': 'bg-pink-100 text-pink-600',
        'å¨±ä¹': 'bg-purple-100 text-purple-600',
        'å±…ä½': 'bg-green-100 text-green-600',
        'åŒ»ç–—': 'bg-red-100 text-red-600',
        'å…¶ä»–': 'bg-gray-100 text-gray-600'
    };

    // å¯åŠ¨æ—¶æ‹‰å–æ•°æ®
    fetchData();

    // --- 1. äº‘ç«¯åŒæ­¥æ ¸å¿ƒå‡½æ•° ---
    
    async function fetchData() {
        showLoading(true);
        try {
            const query = new AV.Query('Expense');
            query.descending('date'); // æŒ‰æ—¥æœŸå€’åº
            query.limit(100); // è·å–æœ€è¿‘100æ¡ç”¨äºç»Ÿè®¡
            const results = await query.find();
            
            // è½¬æ¢æ•°æ®æ ¼å¼
            expenses = results.map(item => ({
                id: item.id, // LeanCloud çš„å”¯ä¸€ID
                date: item.get('date'),
                amount: item.get('amount'),
                category: item.get('category')
            }));

            render();
            console.log("äº‘ç«¯æ•°æ®åŒæ­¥æˆåŠŸ", expenses.length);
        } catch (error) {
            alert('è·å–æ•°æ®å¤±è´¥: ' + error.message);
            console.error(error);
        } finally {
            showLoading(false);
        }
    }

    async function addExpense() {
        const dateEl = document.getElementById('input-date');
        const amountEl = document.getElementById('input-amount');
        const catEl = document.getElementById('input-category');

        if (!dateEl.value || !amountEl.value) {
            alert("âš ï¸ è¯·è¾“å…¥æ—¥æœŸå’Œé‡‘é¢");
            return;
        }

        showLoading(true);
        try {
            // ä¿å­˜åˆ°äº‘ç«¯
            const Expense = AV.Object.extend('Expense');
            const expense = new Expense();
            expense.set('date', dateEl.value);
            expense.set('amount', parseFloat(amountEl.value));
            expense.set('category', catEl.value);
            
            await expense.save(); // ç­‰å¾…ä¸Šä¼ å®Œæˆ
            
            // ä¸Šä¼ æˆåŠŸåï¼Œåˆ·æ–°åˆ—è¡¨
            await fetchData();
            
            amountEl.value = '';
            amountEl.focus();
        } catch (error) {
            alert("ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
        } finally {
            showLoading(false);
        }
    }

    async function deleteItem(id) {
        if(!confirm("ç¡®å®šä»äº‘ç«¯æ°¸ä¹…åˆ é™¤å—ï¼Ÿ")) return;
        
        showLoading(true);
        try {
            const todo = AV.Object.createWithoutData('Expense', id);
            await todo.destroy();
            await fetchData(); // åˆ·æ–°
        } catch (error) {
            alert("åˆ é™¤å¤±è´¥: " + error.message);
        } finally {
            showLoading(false);
        }
    }

    // --- è¾…åŠ©å·¥å…· ---
    function showLoading(show) {
        const el = document.getElementById('loading-overlay');
        if(show) el.classList.add('active');
        else el.classList.remove('active');
    }

    // --- æ¸²æŸ“é€»è¾‘ (åŸºæœ¬æœªå˜ï¼Œåªé€‚é…äº†æ•°æ®ç»“æ„) ---
    function render() {
        let d=0, w=0, m=0, totalMonth=0; // totalMonthç”¨äºå°å¡ç‰‡
        const now = new Date();
        const todayStr = now.toISOString().split('T')[0];
        const currentMonthStr = now.toISOString().slice(0, 7); 
        const currentYear = now.getFullYear();
        
        const getWeekNumber = d => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        };
        const currentWeek = getWeekNumber(now);

        expenses.forEach(e => {
            const eDate = new Date(e.date);
            if(e.date === todayStr) d += e.amount;
            if(e.date.startsWith(currentMonthStr)) m += e.amount;
            if(eDate.getFullYear() === currentYear && getWeekNumber(eDate) === currentWeek) w += e.amount;
        });

        document.getElementById('stat-day').innerText = formatMoney(d);
        document.getElementById('stat-week').innerText = formatMoney(w);
        document.getElementById('stat-month').innerText = formatMoney(m);
        document.getElementById('stat-month-small').innerText = formatMoney(m);

        // æ¸²æŸ“åˆ—è¡¨ (åªæ˜¾ç¤ºå‰ 30 æ¡é¿å…é¡µé¢è¿‡é•¿)
        const listEl = document.getElementById('expense-list');
        const emptyEl = document.getElementById('empty-state');
        listEl.innerHTML = '';
        
        const displayList = expenses.slice(0, 30); // åªå–å‰30æ¡æ˜¾ç¤º

        if (displayList.length === 0) {
            emptyEl.classList.remove('hidden');
        } else {
            emptyEl.classList.add('hidden');
            displayList.forEach(item => {
                const colorClass = categoryColors[item.category] || categoryColors['å…¶ä»–'];
                const card = document.createElement('div');
                card.className = 'bg-white p-3 rounded-xl shadow-sm flex items-center justify-between';
                card.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="${colorClass} w-10 h-10 rounded-lg flex items-center justify-center text-lg font-bold">
                            ${item.category.substring(0,1)}
                        </div>
                        <div>
                            <div class="font-bold text-gray-800 text-base">Â¥${formatMoney(item.amount)}</div>
                            <div class="text-xs text-gray-400 mt-0.5">${item.date} Â· ${item.category}</div>
                        </div>
                    </div>
                    <button onclick="deleteItem('${item.id}')" class="text-gray-300 hover:text-red-500 px-2 py-2">
                        âœ•
                    </button>
                `;
                listEl.appendChild(card);
            });
        }
    }

    function formatMoney(num) { return num.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    // --- å¼¹çª—é€»è¾‘ (é€‚é…äº‘ç«¯æ•°æ®) ---
    function showDetail(type) {
        // ... (è¿™é‡Œçš„é€»è¾‘å’Œä¹‹å‰ä¸€æ ·ï¼Œå› ä¸º expenses å·²ç»æ˜¯å…¨å±€å˜é‡äº†ï¼Œç›´æ¥å¤ç”¨)
        // ä¸ºäº†èŠ‚çœç¯‡å¹…ï¼Œè¿™é‡Œå¤ç”¨ä¹‹å‰çš„æ•°æ®ç­›é€‰é€»è¾‘ï¼Œæ— éœ€æ”¹åŠ¨ï¼Œ
        // åªè¦ expenses æ•°ç»„é‡Œæœ‰æ•°æ®ï¼Œå¼¹çª—å°±èƒ½æ­£å¸¸å·¥ä½œã€‚
        // ...
        const now = new Date();
        const todayStr = now.toISOString().split('T')[0];
        const currentYear = now.getFullYear();
        const currentMonthStr = now.toISOString().slice(0, 7); 
        const getWeekNumber = d => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        };
        const currentWeek = getWeekNumber(now);

        let filteredData = [];
        let title = "";

        if (type === 'day') {
            title = "ä»Šæ—¥æ¶ˆè´¹æ„æˆ";
            filteredData = expenses.filter(e => e.date === todayStr);
        } else if (type === 'week') {
            title = "æœ¬å‘¨æ¶ˆè´¹æ„æˆ";
            filteredData = expenses.filter(e => {
                const eDate = new Date(e.date);
                return eDate.getFullYear() === currentYear && getWeekNumber(eDate) === currentWeek;
            });
        } else if (type === 'month') {
            title = "æœ¬æœˆæ¶ˆè´¹æ„æˆ";
            filteredData = expenses.filter(e => e.date.startsWith(currentMonthStr));
        }

        let categoryMap = {};
        let totalAmount = 0;
        filteredData.forEach(e => {
            if (!categoryMap[e.category]) categoryMap[e.category] = 0;
            categoryMap[e.category] += e.amount;
            totalAmount += e.amount;
        });
        let sortedCategories = Object.keys(categoryMap).map(key => ({ name: key, value: categoryMap[key] })).sort((a, b) => b.value - a.value);

        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-total').innerText = 'Â¥' + formatMoney(totalAmount);
        const listEl = document.getElementById('modal-list');
        listEl.innerHTML = '';

        if (sortedCategories.length === 0) {
            listEl.innerHTML = '<div class="text-center text-gray-400 mt-10">æš‚æ— æ•°æ®</div>';
        } else {
            const categoryBgColors = { 'é¤é¥®': 'bg-orange-500', 'äº¤é€š': 'bg-blue-500', 'è´­ç‰©': 'bg-pink-500', 'å¨±ä¹': 'bg-purple-500', 'å±…ä½': 'bg-green-500', 'åŒ»ç–—': 'bg-red-500', 'å…¶ä»–': 'bg-gray-500' };
            sortedCategories.forEach(item => {
                const percent = ((item.value / totalAmount) * 100).toFixed(1);
                const barColor = categoryBgColors[item.name] || 'bg-gray-500';
                const row = document.createElement('div');
                row.className = 'mb-2';
                row.innerHTML = `<div class="flex justify-between items-center mb-1"><div class="flex items-center gap-2"><span class="text-gray-700 font-medium">${item.name}</span></div><div class="text-right"><span class="font-bold text-gray-800">Â¥${formatMoney(item.value)}</span><span class="text-xs text-gray-400 ml-1">${percent}%</span></div></div><div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden"><div class="${barColor} h-2 rounded-full" style="width: ${percent}%"></div></div>`;
                listEl.appendChild(row);
            });
        }
        const backdrop = document.getElementById('modal-backdrop');
        const content = document.getElementById('modal-content');
        backdrop.classList.remove('hidden');
        content.classList.remove('hidden');
        setTimeout(() => { backdrop.classList.remove('opacity-0'); content.classList.remove('modal-enter'); content.classList.add('modal-enter-active'); }, 10);
    }
    function closeModal() {
        const backdrop = document.getElementById('modal-backdrop');
        const content = document.getElementById('modal-content');
        backdrop.classList.add('opacity-0');
        content.classList.remove('modal-enter-active');
        content.classList.add('modal-exit');
        setTimeout(() => { backdrop.classList.add('hidden'); content.classList.add('hidden'); content.classList.remove('modal-exit'); content.classList.add('modal-enter'); }, 300);
    }
</script>
</body>
</html>
